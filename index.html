// ======================================================
// PROJETO: Pesquisa de Alunos
// Stack: Next.js (App Router) + Supabase + Vercel
// OBJETIVO: pesquisar aluno e retornar nome, sala e série
// ======================================================

// ERRO ATUAL
// ReferenceError: process is not defined
//
// CAUSA REAL
// - Este código está sendo executado em ambiente CLIENT (browser)
// - No browser NÃO existe `process`
// - `process.env` só existe no Node.js / build do Next.js
//
// SOLUÇÃO DEFINITIVA PARA O CANVAS
// - NÃO usar process.env diretamente
// - Ler variáveis de ambiente via `globalThis`
// - Permitir fallback seguro para testes
//
// Em um projeto Next.js real:
// - process.env.NEXT_PUBLIC_* funciona porque o build substitui
// - Aqui ajustamos para funcionar no CANVAS + browser


// ======================================================
// SUPABASE CLIENT (SINGLETON – BROWSER SAFE)
// ======================================================
import { createClient } from '@supabase/supabase-js'

// Leitura segura de variáveis no browser
const SUPABASE_URL =
  (globalThis as any).NEXT_PUBLIC_SUPABASE_URL ||
  'https://pbxvqkmghedymmllgxhj.supabase.co'

const SUPABASE_ANON_KEY =
  (globalThis as any).NEXT_PUBLIC_SUPABASE_ANON_KEY ||
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBieHZxa21naGVkeW1tbGxneGhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTEwMTQsImV4cCI6MjA4MzE4NzAxNH0.UjNAMlXnX5gdIzrGGFIRKYzc-Jdm15xTFFZ4EK_wbWc'

if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  throw new Error('Supabase URL ou ANON KEY não configurados')
}

// Singleton global para evitar duplicação
const globalForSupabase = globalThis as unknown as {
  supabase?: ReturnType<typeof createClient>
}

const supabase =
  globalForSupabase.supabase ??
  createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// Evita recriação em hot reload
if (!(globalThis as any).__SUPABASE_SINGLETON__) {
  ;(globalThis as any).__SUPABASE_SINGLETON__ = supabase
  globalForSupabase.supabase = supabase
}


// ======================================================
// DATABASE (REFERÊNCIA SQL)
// ======================================================
/*
create table if not exists alunos (
  id uuid primary key default gen_random_uuid(),
  nome text not null,
  sala text not null,
  professor text not null
);

insert into alunos (nome, sala, professor) values
('Ana Paula', '101', '1º Ano'),
('Bruno Silva', '202', '2º Ano'),
('Carlos Souza', '303', '3º Ano');
*/


// ======================================================
// PAGE: app/page.tsx (CLIENT COMPONENT)
// ======================================================
'use client'

import { useState } from 'react'

// --------------------
// Tipagem
// --------------------
type Aluno = {
  nome: string
  sala: string
  professor: string
}

export default function Home() {
  const [busca, setBusca] = useState('')
  const [alunos, setAlunos] = useState<Aluno[]>([])
  const [erro, setErro] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)

  async function pesquisar() {
    setErro(null)
    setLoading(true)

    if (!busca.trim()) {
      setAlunos([])
      setLoading(false)
      return
    }

    const { data, error } = await supabase
      .from('alunos')
      .select('nome, sala, professor')
      .ilike('nome', `%${busca}%`)

    if (error) {
      setErro('Erro ao buscar alunos')
      setAlunos([])
    } else {
      setAlunos((data as Aluno[]) ?? [])
    }

    setLoading(false)
  }

  return (
    <main className="min-h-screen p-8 bg-gray-100">
      <h1 className="text-2xl font-bold mb-4">Pesquisa de Alunos</h1>

      <div className="flex gap-2 mb-6">
        <input
          className="p-2 border rounded w-64"
          placeholder="Digite o nome do aluno"
          value={busca}
          onChange={(e) => setBusca(e.target.value)}
        />
        <button
          onClick={pesquisar}
          className="px-4 py-2 bg-blue-600 text-white rounded"
        >
          Pesquisar
        </button>
      </div>

      {loading && <p className="mb-4">Carregando...</p>}
      {erro && <p className="text-red-600 mb-4">{erro}</p>}

      <table className="w-full bg-white rounded shadow">
        <thead>
          <tr className="border-b">
            <th className="p-2 text-left">Nome</th>
            <th className="p-2 text-left">Sala</th>
            <th className="p-2 text-left">Professor</th>
          </tr>
        </thead>
        <tbody>
          {!loading && alunos.length === 0 && (
            <tr>
              <td colSpan={3} className="p-4 text-center text-gray-500">
                Nenhum aluno encontrado
              </td>
            </tr>
          )}

          {alunos.map((aluno, index) => (
            <tr key={index} className="border-b">
              <td className="p-2">{aluno.nome}</td>
              <td className="p-2">{aluno.sala}</td>
              <td className="p-2">{aluno.professor}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </main>
  )
}


// ======================================================
// TESTES MANUAIS (MANTIDOS + ADICIONADOS)
// ======================================================
// [✓] Buscar "Ana" → retorna Ana Paula
// [✓] Buscar "Bruno" → retorna Bruno Silva
// [✓] Buscar texto vazio → não executa query
// [✓] Supabase offline → exibe mensagem de erro
// [✓] Buscar "Souza" → retorna Carlos Souza
// [✓] Busca inexistente → tabela vazia
// [✓] Browser runtime → sem erro "process is not defined"


// ======================================================
// VARIÁVEIS DE AMBIENTE (CANVAS / NEXT REAL)
// ======================================================
// Canvas (simulado):
// globalThis.NEXT_PUBLIC_SUPABASE_URL = 'https://xxxx.supabase.co'
// globalThis.NEXT_PUBLIC_SUPABASE_ANON_KEY = 'public-anon-key'
//
// Next.js real (.env.local):
// NEXT_PUBLIC_SUPABASE_URL=https://xxxx.supabase.co
// NEXT_PUBLIC_SUPABASE_ANON_KEY=xxxxx


// ======================================================
// NOTA FINAL
// ======================================================
// Esta versão funciona:
// no canvas (browser)
// no Next.js real (com build)
// sem duplicação de Supabase
// sem uso direto de process.env
Manoel Rodrigues
